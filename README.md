#Cold storage with `_purge`-ing

This script implements a solution for cold storage by using CouchDb _purge.
Takes a CSV or text file as an input. The file should have one uuid - representing the _id of a document - to be purged on each line.
One action of the script will create a collection of documents to be purged based on these rules:

- the document from `medic` db - all leaf revs, including conflicted ones
- infodoc from `medic-sentinel` db
- purged:doc entries from purging databases
- all tombstones
- if the document is a report, purges all tasks that have that document as a source_id

The collection of documents is saved in a provided output location, in the format of once csv file per database, each csv containing uuids to be purged from that database.
The list of ids to be purged can be inspected before proceeding to the actual purging step - which is destructive.

The other action of the script will actually purge the generated collection of documents described above. It will also save every purged document in a secondary database `medic-cold-storage`.

NB. The script uses a mango query (and a custom mango index) top get the list of tasks associated by source_id with a data_record. Depending on the size of the database, quering using this index for the first time can take a long time. The script has an action to pre-index to make main execution faster.

Usage:

## Installation

```
npm ci
npm link
```

## create-index

Creates and indexes Mango index used for source_id task searches.
```
 node ./bin/create-index.js --url=http://admin:pass@127.0.0.1:6984
```

## get-ids
Provided with a csv/text file containing list of uuids of docs to be purged, outputs a collection of database-docs lists that can be inspected before the destructive operation of purging.
```
node ./bin/get-ids.js --url=http://admin:pass@127.0.0.1:6984 --input=<path_to>/input.csv --output=<path_to>/out
```

## purge
Provided with a collection documents to purge generated by `get-ids`, makes a copy of every document in a separate database called `medic-cold-storage` and purges the document from the designated database.
The document saved in cold storage will use this _id format: `<database>:<doc._id>:<doc._rev>`.
```
node ./bin/purge.js --url=http://admin:pass@127.0.0.1:6984 --input=<path_to>/out
```
